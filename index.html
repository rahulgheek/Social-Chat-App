<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Chat</title>
    <style>
        /* --- DESIGN SYSTEM & MODERN RESET --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --primary-hue: 225;
            --primary-saturation: 85%;
            --primary-lightness: 60%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            --primary-color-hover: hsl(var(--primary-hue), var(--primary-saturation), 50%);
            --primary-color-focus: hsla(var(--primary-hue), var(--primary-saturation), 50%, 0.2);
            --primary-gradient: linear-gradient(135deg, hsl(var(--primary-hue), 80%, 65%) 0%, hsl(var(--primary-hue), 70%, 55%) 100%);
            
            --background-dark: #0A0B0D;
            --surface-dark-1: #131419;
            --surface-dark-2: #1A1D24;
            --surface-dark-3: #252932;
            --surface-dark-4: #2F343E;

            --text-primary: #F8FAFC;
            --text-secondary: #94A3B8;
            --text-tertiary: #64748B;
            --border-color: #334155;
            --border-color-light: #475569;
            --error-color: #EF4444;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --online-indicator: #22C55E;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.7);

            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --backdrop-blur: blur(20px);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: radial-gradient(ellipse at top, #1e293b 0%, var(--background-dark) 50%);
            background-attachment: fixed;
            display: grid;
            place-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        }

        /* --- VIEW MANAGEMENT --- */
        .view { 
            display: none; 
            width: 100%; 
            height: 100vh;
        }
        .view.active { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        
        /* --- AUTHENTICATION WRAPPER --- */
        .auth-wrapper { 
            display: flex; 
            width: min(95vw, 1200px); 
            height: min(90vh, 720px);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 32px; 
            box-shadow: var(--shadow-2xl); 
            overflow: hidden; 
            position: relative;
        }
        
        /* --- FORM PANEL STYLING --- */
        .form-panel { 
            flex: 1; 
            padding: clamp(24px, 5vw, 64px) clamp(32px, 6vw, 80px); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            position: relative; 
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
        }
        .form-view { 
            position: absolute; 
            width: calc(100% - clamp(64px, 12vw, 160px)); 
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .form-view:not(.visible) { 
            opacity: 0; 
            pointer-events: none; 
            transform: translateX(30px);
        }
        .form-header h1 { 
            font-size: clamp(28px, 4vw, 42px); 
            font-weight: 800; 
            margin-bottom: 12px; 
            color: var(--text-primary); 
            background: linear-gradient(135deg, #fff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .form-header p { 
            font-size: clamp(15px, 2vw, 18px); 
            color: var(--text-secondary); 
            margin-bottom: clamp(32px, 5vw, 48px); 
            font-weight: 400;
        }
        .form-group { 
            position: relative; 
            margin-bottom: clamp(20px, 3vw, 28px); 
        }
        .form-icon { 
            position: absolute; 
            left: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-tertiary); 
            pointer-events: none; 
            transition: all 0.3s ease;
            z-index: 2;
        }
        .form-input { 
            width: 100%; 
            padding: clamp(16px, 2.5vw, 20px) clamp(16px, 2.5vw, 20px) clamp(16px, 2.5vw, 20px) clamp(52px, 8vw, 64px); 
            border: 2px solid var(--border-color); 
            border-radius: 16px; 
            font-size: clamp(15px, 2vw, 17px); 
            font-weight: 500; 
            color: var(--text-primary); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
        }
        .form-input::placeholder { 
            color: var(--text-tertiary); 
            font-weight: 400;
        }
        .form-input:focus { 
            outline: none; 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 6px var(--primary-color-focus), var(--shadow-lg);
            transform: translateY(-2px);
        }
        .form-input:focus ~ .form-icon { 
            color: var(--primary-color); 
            transform: translateY(-50%) scale(1.1);
        }
        .form-button { 
            width: 100%; 
            padding: clamp(18px, 3vw, 22px); 
            border: none; 
            border-radius: 16px; 
            background: var(--primary-gradient);
            color: white; 
            font-size: clamp(16px, 2.5vw, 18px); 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            box-shadow: var(--shadow-lg);
        }
        .form-button:hover:not(:disabled) { 
            background: var(--primary-color-hover);
            box-shadow: 0 12px 32px hsla(var(--primary-hue), var(--primary-saturation), 50%, 0.4);
            transform: translateY(-3px);
        }
        .form-button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        .form-button:disabled { 
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            cursor: not-allowed; 
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        .toggle-text { 
            text-align: center; 
            margin-top: clamp(24px, 4vw, 40px); 
            color: var(--text-secondary); 
            font-size: clamp(14px, 2vw, 16px);
        }
        .toggle-text a { 
            color: var(--primary-color); 
            font-weight: 600; 
            cursor: pointer; 
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .toggle-text a:hover {
            color: var(--primary-color-hover);
        }
        .error-message { 
            color: var(--error-color); 
            text-align: center; 
            font-weight: 500; 
            min-height: 1.5em; 
            margin-bottom: 20px; 
            opacity: 0; 
            transform: translateY(-10px);
            font-size: clamp(13px, 2vw, 15px);
        }
        
        /* --- ILLUSTRATION PANEL --- */
        .illustration-panel { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .illustration-image { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            opacity: 0.6; 
            transition: all 0.6s ease-out;
            filter: brightness(0.8) contrast(1.1);
        }
        .auth-wrapper:hover .illustration-image { 
            transform: scale(1.08); 
            opacity: 0.7; 
        }
        .illustration-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(145deg, 
                hsla(var(--primary-hue), 60%, 60%, 0.15) 0%, 
                rgba(0,0,0,0.8) 60%,
                rgba(0,0,0,0.9) 100%
            );
        }
        .illustration-content { 
            position: absolute; 
            bottom: clamp(32px, 6vw, 64px); 
            left: clamp(32px, 6vw, 64px); 
            right: clamp(32px, 6vw, 64px);
            color: white; 
            z-index: 5; 
        }
        .illustration-content h2 { 
            font-size: clamp(28px, 5vw, 48px); 
            font-weight: 800; 
            line-height: 1.2; 
            margin-bottom: clamp(16px, 3vw, 24px); 
            text-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        .illustration-content p { 
            font-size: clamp(16px, 2.5vw, 20px); 
            max-width: 400px; 
            opacity: 0.95; 
            text-shadow: 0 3px 10px rgba(0,0,0,0.6);
            line-height: 1.6;
        }
        
        /* --- CHAT DASHBOARD --- */
        .chat-app-wrapper { 
            width: min(98vw, 1400px); 
            height: min(96vh, 800px); 
            display: flex; 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-radius: 28px; 
            box-shadow: var(--shadow-2xl); 
            border: 1px solid var(--glass-border); 
            overflow: hidden;
        }
        
        /* --- SIDEBAR PANEL --- */
        .sidebar-panel { 
            flex: 0 0 clamp(72px, 10vw, 88px); 
            background: var(--surface-dark-1);
            border-right: 1px solid var(--border-color); 
            padding: clamp(20px, 3vw, 32px) 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between;
            position: relative;
        }
        .sidebar-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(180deg, 
                hsla(var(--primary-hue), 40%, 30%, 0.1) 0%, 
                transparent 100%
            );
            pointer-events: none;
        }
        .sidebar-icon { 
            position: relative; 
            cursor: pointer; 
            color: var(--text-secondary); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 16px;
            border-radius: 16px;
            background: transparent;
        }
        .sidebar-icon:hover { 
            color: var(--text-primary); 
            transform: scale(1.15);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
        }
        .sidebar-icon.active { 
            color: var(--primary-color);
            background: var(--primary-color-focus);
            box-shadow: var(--shadow-md);
        }
        .sidebar-icon .badge { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: white; 
            font-size: 10px; 
            font-weight: 700; 
            padding: 3px 6px; 
            border-radius: 12px; 
            border: 2px solid var(--surface-dark-1);
            box-shadow: var(--shadow-sm);
        }
        
        /* --- CONVERSATIONS PANEL --- */
        .conversations-panel { 
            flex: 0 0 clamp(280px, 35vw, 360px); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            background: var(--surface-dark-1);
        }
        .conversations-header { 
            padding: clamp(16px, 2.5vw, 24px) clamp(16px, 2.5vw, 24px) 0; 
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, var(--surface-dark-1) 0%, var(--surface-dark-2) 100%);
        }
        .conversations-header h2 { 
            font-size: clamp(18px, 3vw, 22px); 
            font-weight: 800; 
            color: var(--text-primary); 
            padding: 0 12px clamp(12px, 2vw, 16px);
            background: linear-gradient(135deg, #fff 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .tabs { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 8px; 
            padding: 0 12px clamp(12px, 2vw, 16px); 
        }
        .tab-button { 
            padding: clamp(10px, 1.5vw, 14px) clamp(8px, 1.5vw, 12px); 
            border-radius: 14px; 
            border: 1px solid var(--border-color); 
            background: var(--surface-dark-2); 
            color: var(--text-secondary); 
            cursor: pointer; 
            font-weight: 600; 
            font-size: clamp(12px, 1.8vw, 14px);
            transition: all 0.3s ease;
        }
        .tab-button.active { 
            color: var(--text-primary); 
            border-color: var(--primary-color); 
            background: var(--primary-color-focus);
            box-shadow: 0 0 0 3px hsla(var(--primary-hue), var(--primary-saturation), 50%, 0.1), var(--shadow-sm);
        }
        .search-form { 
            display: flex; 
            margin-top: 12px; 
            gap: 8px;
        }
        .search-form input { 
            flex-grow: 1; 
            padding: clamp(10px, 1.5vw, 14px) clamp(10px, 1.5vw, 14px) clamp(10px, 1.5vw, 14px) clamp(40px, 6vw, 48px); 
            border-radius: 14px; 
            border: 1px solid var(--border-color); 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            font-size: clamp(13px, 2vw, 15px); 
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .search-form input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-color-focus);
        }
        .search-form button { 
            padding: 0 clamp(12px, 2vw, 16px); 
            border: 1px solid var(--primary-color); 
            background: var(--primary-gradient);
            color: white; 
            border-radius: 14px; 
            cursor: pointer;
            font-weight: 600;
            font-size: clamp(12px, 1.8vw, 14px);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        .search-form button:hover {
            background: var(--primary-color-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .search-bar { 
            position: relative; 
        }
        .search-bar svg { 
            position: absolute; 
            left: clamp(12px, 2vw, 16px); 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-tertiary); 
        }
        .friend-requests { 
            padding: clamp(16px, 2.5vw, 20px); 
            border-top: 1px solid var(--border-color);
        }
        .friend-requests-header { 
            font-size: clamp(13px, 2vw, 15px); 
            font-weight: 700; 
            color: var(--text-secondary); 
            margin-bottom: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .friend-request-item { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: clamp(8px, 1.5vw, 12px); 
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .friend-request-item:hover { 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
        }
        .request-buttons button { 
            font-size: clamp(11px, 1.5vw, 13px); 
            font-weight: 600; 
            padding: clamp(4px, 1vw, 6px) clamp(8px, 1.5vw, 10px); 
            border-radius: 8px; 
            cursor: pointer; 
            border: none;
            transition: all 0.2s ease;
        }
        .accept-btn { 
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white; 
            margin-right: 6px;
            box-shadow: var(--shadow-sm);
        }
        .accept-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .decline-btn { 
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: white;
            box-shadow: var(--shadow-sm);
        }
        .decline-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .conversations-list-header { 
            padding: clamp(16px, 2.5vw, 20px) clamp(16px, 2.5vw, 20px) clamp(8px, 1.5vw, 12px); 
            font-size: clamp(13px, 2vw, 15px); 
            font-weight: 700; 
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .conversations-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: clamp(8px, 1.5vw, 12px);
        }
        .conversation-item { 
            display: grid; 
            grid-template-columns: clamp(48px, 8vw, 56px) 1fr auto; 
            align-items: center; 
            gap: clamp(12px, 2vw, 16px); 
            padding: clamp(12px, 2vw, 16px); 
            border-radius: 16px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
        }
        .conversation-item:hover { 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            transform: translateX(4px);
        }
        .conversation-item.active { 
            background: var(--primary-color);
            box-shadow: var(--shadow-lg);
            transform: translateX(8px);
        }
        .avatar { 
            position: relative; 
            width: clamp(48px, 8vw, 56px); 
            height: clamp(48px, 8vw, 56px); 
            border-radius: 50%; 
            background: var(--surface-dark-3);
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .avatar img { 
            width: 100%; 
            height: 100%; 
            border-radius: 50%; 
            object-fit: cover; 
        }
        .status-dot { 
            position: absolute; 
            bottom: 2px; 
            right: 2px; 
            width: clamp(12px, 2vw, 16px); 
            height: clamp(12px, 2vw, 16px); 
            background-color: var(--text-secondary); 
            border: 3px solid var(--surface-dark-1); 
            border-radius: 50%; 
            transition: all 0.3s ease;
        }
        .status-dot.online { 
            background-color: var(--online-indicator);
            box-shadow: 0 0 8px var(--online-indicator);
        }
        .conversation-details { 
            min-width: 0; 
        }
        .conversation-details .name { 
            font-weight: 600; 
            font-size: clamp(15px, 2.5vw, 17px); 
            color: var(--text-primary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .conversation-item.active .conversation-details .name { 
            color: white; 
        }
        .message-preview { 
            font-size: clamp(12px, 2vw, 14px); 
            color: var(--text-secondary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .conversation-item.active .conversation-details .message-preview { 
            color: hsla(0, 0%, 100%, 0.8); 
        }
        .conversation-meta { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            gap: 6px; 
        }
        .conversation-time { 
            font-size: clamp(10px, 1.5vw, 12px); 
            color: var(--text-tertiary);
            font-weight: 500;
        }
        .badge { 
            min-width: clamp(18px, 3vw, 22px); 
            height: clamp(18px, 3vw, 22px); 
            padding: 0 clamp(6px, 1vw, 8px); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px; 
            background: linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%);
            color: #fff; 
            font-size: clamp(10px, 1.5vw, 12px); 
            font-weight: 700;
            box-shadow: var(--shadow-sm);
        }
        
        /* --- CHAT PANEL --- */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface-dark-2);
            overflow: hidden;
            min-height: 0;
            position: relative;
        }
        .chat-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: radial-gradient(ellipse at top, 
                hsla(var(--primary-hue), 30%, 20%, 0.1) 0%, 
                transparent 60%
            );
            pointer-events: none;
        }
        .chat-placeholder { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            color: var(--text-secondary); 
            text-align: center;
            background: radial-gradient(ellipse at center, 
                hsla(var(--primary-hue), 20%, 15%, 0.3) 0%, 
                transparent 60%
            );
        }
        .chat-placeholder h2 {
            font-size: clamp(20px, 3vw, 28px);
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .chat-placeholder p {
            font-size: clamp(14px, 2vw, 16px);
            opacity: 0.7;
        }
        .chat-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: clamp(16px, 2.5vw, 24px); 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--border-color); 
            box-shadow: var(--shadow-md); 
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .chat-header .left { 
            display: flex; 
            align-items: center; 
            gap: clamp(12px, 2vw, 16px); 
        }
        .chat-header .actions { 
            display: flex; 
            gap: clamp(8px, 1.5vw, 12px); 
        }
        .icon-button { 
            width: clamp(36px, 6vw, 44px); 
            height: clamp(36px, 6vw, 44px); 
            display: grid; 
            place-items: center; 
            border-radius: 12px; 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color); 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .icon-button:hover { 
            color: var(--primary-color); 
            background: var(--primary-color-focus);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .icon-button:active { 
            transform: translateY(0px); 
        }
        .chat-header .user-info .name {
            font-size: clamp(16px, 2.5vw, 20px);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .chat-header .user-info .status-text { 
            color: var(--text-secondary); 
            font-size: clamp(13px, 2vw, 15px);
            font-weight: 500;
        }
        .chat-header .user-info .status-text.online { 
            color: var(--online-indicator); 
            font-weight: 600;
        }
        .message-area { 
            flex: 1; 
            overflow-y: auto; 
            padding: clamp(16px, 3vw, 32px); 
            display: flex; 
            flex-direction: column; 
            gap: 4px;
            position: relative;
            z-index: 1;
        }
        .day-divider { 
            align-self: center; 
            margin: clamp(12px, 2vw, 20px) 0; 
            font-size: clamp(11px, 1.8vw, 13px); 
            color: var(--text-tertiary); 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            padding: clamp(4px, 1vw, 8px) clamp(10px, 2vw, 16px); 
            border-radius: 20px; 
            border: 1px solid var(--border-color);
            font-weight: 600;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .message-row { 
            display: flex; 
            align-items: flex-end; 
            gap: clamp(8px, 1.5vw, 12px); 
            margin-bottom: 2px;
        }
        .message-row.sent { 
            justify-content: flex-end; 
        }
        .message-bubble { 
            max-width: min(75%, 500px); 
            padding: clamp(12px, 2vw, 16px) clamp(14px, 2.5vw, 18px); 
            border-radius: 20px; 
            margin: 2px 0; 
            line-height: 1.6; 
            word-wrap: break-word; 
            position: relative;
            font-size: clamp(14px, 2.2vw, 16px);
            box-shadow: var(--shadow-sm);
        }
        .message-bubble.received { 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 8px; 
        }
        .message-bubble.sent { 
            background: var(--primary-gradient);
            color: white; 
            border-bottom-right-radius: 8px;
            box-shadow: var(--shadow-md);
        }
        .message-time { 
            font-size: clamp(10px, 1.5vw, 12px); 
            opacity: 0.7; 
            margin-top: 6px;
            font-weight: 500;
        }
        .chat-input-area { 
            padding: clamp(12px, 2vw, 20px); 
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-top: 1px solid var(--border-color); 
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }
        .chat-input-form { 
            display: flex; 
            align-items: flex-end; 
            gap: clamp(8px, 1.5vw, 12px); 
            background: var(--surface-dark-3);
            border: 2px solid var(--border-color); 
            border-radius: 20px; 
            padding: clamp(6px, 1vw, 10px);
            transition: all 0.3s ease;
        }
        .chat-input { 
            flex: 1; 
            padding: clamp(10px, 2vw, 14px) clamp(12px, 2vw, 16px); 
            border-radius: 16px; 
            border: 0; 
            background-color: transparent; 
            font-size: clamp(14px, 2.2vw, 16px); 
            resize: none; 
            color: var(--text-primary); 
            outline: none; 
            max-height: clamp(100px, 15vw, 140px);
            font-family: inherit;
            line-height: 1.5;
        }
        .chat-input::placeholder {
            color: var(--text-tertiary);
        }
        .send-button { 
            width: clamp(36px, 6vw, 44px); 
            height: clamp(36px, 6vw, 44px); 
            border: none;
            background: var(--primary-gradient);
            color: #fff; 
            border-radius: 14px; 
            display: grid; 
            place-items: center; 
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }
        .send-button:hover { 
            background: var(--primary-color-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .send-button:active {
            transform: translateY(0px);
        }
        .send-button svg { 
            pointer-events: none; 
        }
        .chat-input-form:focus-within { 
            box-shadow: 0 0 0 4px var(--primary-color-focus); 
            border-color: var(--primary-color); 
        }
        
        /* --- SCROLLBAR STYLING --- */
        .message-area::-webkit-scrollbar, .conversations-list::-webkit-scrollbar { 
            width: 8px; 
        }
        .message-area::-webkit-scrollbar-thumb, .conversations-list::-webkit-scrollbar-thumb { 
            background: var(--border-color-light);
            border-radius: 10px; 
            border: 2px solid var(--surface-dark-2);
        }
        .message-area::-webkit-scrollbar-track, .conversations-list::-webkit-scrollbar-track { 
            background: var(--surface-dark-1); 
        }
        .message-area::-webkit-scrollbar-thumb:hover, .conversations-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* --- ANIMATION & LOADING --- */
        .spinner { 
            display: none; 
            width: 20px; 
            height: 20px; 
            border: 2px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50%; 
            border-top-color: #fff; 
            animation: spin 1s ease-in-out infinite; 
        }
        .form-button.loading .spinner { 
            display: block; 
        }
        .form-button.loading .button-text { 
            display: none; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        .anime-element { 
            opacity: 0; 
            transform: translateY(20px); 
        }
        .hidden { 
            display: none !important; 
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 1200px) {
            .chat-app-wrapper { 
                max-width: 95vw; 
                max-height: 95vh; 
                border-radius: 20px; 
            }
        }

        @media (max-width: 1024px) {
            .chat-app-wrapper { 
                max-width: 98vw; 
                max-height: 98vh; 
                border-radius: 16px; 
            }
            .auth-wrapper {
                height: min(85vh, 640px);
                border-radius: 24px;
            }
        }

        @media (max-width: 768px) {
            .sidebar-panel { 
                display: none; 
            }
            .conversations-panel { 
                flex: 0 0 clamp(260px, 40vw, 300px); 
            }
            .chat-app-wrapper {
                border-radius: 12px;
            }
            .auth-wrapper {
                flex-direction: column;
                width: min(95vw, 480px);
                height: auto;
                max-height: 95vh;
            }
            .illustration-panel {
                order: -1;
                flex: 0 0 200px;
            }
            .form-panel {
                padding: clamp(20px, 4vw, 32px);
            }
        }

        @media (max-width: 640px) {
            .conversations-panel { 
                flex: 0 0 100%;
                border-right: none;
            }
            .chat-panel {
                display: none;
            }
            .conversations-panel.chat-open {
                display: none;
            }
            .chat-panel.chat-open {
                display: flex;
            }
            .chat-app-wrapper {
                border-radius: 8px;
            }
            .auth-wrapper {
                width: 95vw;
                border-radius: 16px;
            }
            .illustration-panel {
                flex: 0 0 150px;
            }
        }

        @media (max-width: 480px) {
            .auth-wrapper {
                width: 98vw;
                height: 98vh;
                border-radius: 12px;
            }
            .chat-app-wrapper {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                max-width: none;
                max-height: none;
            }
            .form-panel {
                padding: 20px;
            }
            .illustration-panel {
                flex: 0 0 120px;
            }
        }

        /* --- ENHANCED VISUAL EFFECTS --- */
        .form-button:hover:not(:disabled)::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: translateX(-100%);
            animation: shimmer 0.6s ease-out;
        }

        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }

        .message-bubble:hover {
            transform: translateY(-1px);
            transition: transform 0.2s ease;
        }

        .conversation-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            border-radius: 0 4px 4px 0;
            opacity: 0;
            transform: scaleY(0);
            transition: all 0.3s ease;
        }

        .conversation-item.active::before {
            opacity: 1;
            transform: scaleY(1);
        }

        /* --- ACCESSIBILITY IMPROVEMENTS --- */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-contrast: high) {
            :root {
                --border-color: #64748B;
                --text-secondary: #CBD5E1;
            }
        }

        /* --- FOCUS INDICATORS --- */
        .form-input:focus,
        .chat-input:focus,
        .tab-button:focus,
        .icon-button:focus,
        .send-button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .sidebar-icon:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 4px;
        }

    </style>
</head>
<body>

    <div id="auth-view" class="view active">
        <div class="auth-wrapper">
            <div class="form-panel">
                <div id="login-view" class="form-view visible">
                    <div class="form-header"><h1 class="anime-element">Welcome Back</h1><p class="anime-element">Connect and collaborate instantly.</p></div>
                    <div id="login-error" class="error-message"></div>
                    <form id="login-form">
                        <div class="form-group anime-element"><span class="form-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span><input type="text" id="login-username" class="form-input" placeholder="Username" required></div>
                        <div class="form-group anime-element"><span class="form-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span><input type="password" id="login-password" class="form-input" placeholder="Password" required></div>
                        <div class="anime-element"><button type="submit" class="form-button"><span class="button-text">Sign In</span><div class="spinner"></div></button></div>
                    </form>
                    <div class="toggle-text anime-element">Don't have an account? <a id="show-register-link">Sign Up</a></div>
                </div>
                <div id="register-view" class="form-view">
                    <div class="form-header"><h1 class="anime-element">Create Account</h1><p class="anime-element">Start your journey with us today.</p></div>
                    <div id="register-error" class="error-message"></div>
                    <form id="register-form">
                        <div class="form-group anime-element"><span class="form-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg></span><input type="text" id="register-username" class="form-input" placeholder="Username" required></div>
                        <div class="form-group anime-element"><span class="form-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span><input type="password" id="register-password" class="form-input" placeholder="Password" required></div>
                        <div class="anime-element"><button type="submit" class="form-button"><span class="button-text">Create Account</span><div class="spinner"></div></button></div>
                    </form>
                    <div class="toggle-text anime-element">Already have an account? <a id="show-login-link">Sign In</a></div>
                </div>
            </div>
            <div class="illustration-panel"><div class="illustration-overlay"></div><img src="https://images.unsplash.com/photo-1522071820081-009f0129c7da?q=80&w=2670&auto=format&fit=crop" alt="Team collaborating" class="illustration-image" onerror="this.onerror=null;this.src='https://placehold.co/600x800/1a202c/ffffff?text=Image';"><div class="illustration-content"><h2 class="anime-element">Where Ideas<br>Find Their Voice.</h2><p class="anime-element">The ultimate platform for real-time team collaboration and communication.</p></div></div>
        </div>
    </div>

    <div id="chat-app-view" class="view">
        <div class="chat-app-wrapper">
            <div class="sidebar-panel">
                <div> <div class="sidebar-icon active">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    </div>
                </div>
                <div> <div class="sidebar-icon" id="logout-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    </div>
                </div>
            </div>
            <div class="conversations-panel">
                <div class="conversations-header"><h2 id="current-username"></h2>
                    <div class="tabs"><button id="tab-friends" class="tab-button active" type="button">Friends</button><button id="tab-requests" class="tab-button" type="button">Requests</button></div>
                    <form id="search-form" class="search-form"><div class="search-bar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><input type="text" id="search-input" placeholder="Add friend by username..."></div><button type="submit">Add</button></form>
                </div>
                <div id="requests-view" class="friend-requests hidden"><div class="friend-requests-header">Incoming Requests</div><div id="friend-requests-list"></div></div>
                <div id="friends-view">
                    <div class="conversations-list-header">Friends</div>
                    <div id="conversations-list" class="conversations-list"></div>
                </div>
            </div>
            <div id="chat-panel" class="chat-panel">
                 <div id="chat-placeholder" class="chat-placeholder"><h2>Select a friend to start chatting</h2><p>Your conversations will appear here.</p></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://social-chat-app-ltbi.onrender.com';
            const WS_URL = 'wss://social-chat-app-ltbi.onrender.com';
            
            let ws; let currentUserId; let activeChatFriendId = null;

            // --- ELEMENT SELECTORS ---
            const authView = document.getElementById('auth-view'); const chatAppView = document.getElementById('chat-app-view');
            const loginView = document.getElementById('login-view'); const registerView = document.getElementById('register-view');
            const loginForm = document.getElementById('login-form'); const registerForm = document.getElementById('register-form');
            const showRegisterLink = document.getElementById('show-register-link'); const showLoginLink = document.getElementById('show-login-link');
            const loginError = document.getElementById('login-error'); const registerError = document.getElementById('register-error');
            const conversationsList = document.getElementById('conversations-list'); const chatPanel = document.getElementById('chat-panel');
            const searchForm = document.getElementById('search-form'); const searchInput = document.getElementById('search-input');
            const requestsView = document.getElementById('requests-view'); const friendRequestsList = document.getElementById('friend-requests-list');
            const friendsView = document.getElementById('friends-view');
            const tabFriends = document.getElementById('tab-friends'); const tabRequests = document.getElementById('tab-requests');
            const currentUsernameEl = document.getElementById('current-username'); const logoutButton = document.getElementById('logout-button');

            // --- ANIMATION & UI LOGIC ---
            const animateEntrance = (view) => { anime.timeline({ easing: 'easeOutExpo' }).add({ targets: view.querySelectorAll('.anime-element'), translateY: [20, 0], opacity: [0, 1], duration: 600, delay: anime.stagger(80, {start: 200}) }); };
            const switchView = (viewToShow, viewToHide) => { viewToHide.classList.remove('visible'); viewToShow.classList.add('visible'); anime.timeline({ easing: 'easeInOutExpo', complete: () => animateEntrance(viewToShow) }).add({ targets: viewToHide.querySelectorAll('.anime-element'), translateY: [0, -20], opacity: [1, 0], duration: 300, delay: anime.stagger(50) }).add({ targets: viewToHide, translateX: '-100%', opacity: 0, duration: 500, delay: 100 }, 0).add({ targets: viewToShow, translateX: ['100%', '0%'], opacity: [0, 1], duration: 500 }, 100); };
            const transitionToChat = () => { anime.timeline({ easing: 'easeOutExpo' }).add({ targets: authView, scale: 0.95, opacity: 0, duration: 500, complete: () => { authView.classList.remove('active'); chatAppView.classList.add('active'); anime({ targets: chatAppView, scale: [0.95, 1], opacity: [0, 1], duration: 500 }); } }); };
            const showError = (element, message) => { element.textContent = message; anime({ targets: element, opacity: [0, 1], translateY: [-10, 0], duration: 300, easing: 'easeOutExpo' }); };
            const toggleLoading = (button, isLoading) => { button.disabled = isLoading; button.classList.toggle('loading', isLoading); };

            // --- REAL-TIME & API LOGIC ---
            const apiRequest = async (endpoint, method, body) => { const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` }; const options = { method, headers }; if (body) options.body = JSON.stringify(body); const response = await fetch(`${API_URL}${endpoint}`, options); if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'An error occurred'); } return response.status !== 204 ? response.json() : null; };
            
            const handleWebSocketMessage = (data) => {
                if (data.type === 'friend_online' || data.type === 'friend_offline') {
                    const friendId = data.user._id;
                    const isOnline = data.type === 'friend_online';
                    const listDot = document.querySelector(`.conversation-item[data-user-id="${friendId}"] .status-dot`);
                    if (listDot) listDot.classList.toggle('online', isOnline);
                    if (friendId === activeChatFriendId) {
                        const headerDot = document.querySelector('.chat-header .status-dot');
                        const headerText = document.querySelector('.chat-header .status-text');
                        if (headerDot) headerDot.classList.toggle('online', isOnline);
                        if (headerText) {
                            headerText.classList.toggle('online', isOnline);
                            headerText.textContent = isOnline ? 'Online' : 'Offline';
                        }
                    }
                } else if (data.type === 'new_message') {
                     if (data.message.sender._id === activeChatFriendId) appendMessage(data.message, 'received');
                }
            };
            const connectWebSocket = (token) => { ws = new WebSocket(WS_URL); ws.onopen = () => { ws.send(JSON.stringify({ type: 'auth', token })); }; ws.onmessage = (event) => { handleWebSocketMessage(JSON.parse(event.data)); }; ws.onclose = () => {}; ws.onerror = (error) => { console.error('WebSocket error:', error); }; };

            const updateRequestsBadge = (count) => {
                if (!tabRequests) return;
                tabRequests.textContent = count > 0 ? `Requests (${count})` : 'Requests';
            };
            const renderFriendRequests = (requests) => {
                if (!friendRequestsList) return;
                if (requests.length === 0) { friendRequestsList.innerHTML = '<div class="message-preview">No pending requests</div>'; updateRequestsBadge(0); return; }
                friendRequestsList.innerHTML = requests.map(req => `
                    <div class="friend-request-item" data-request-id="${req._id}">
                        <span><strong>${req.from.username}</strong></span>
                        <div class="request-buttons"><button class="accept-btn">Accept</button><button class="decline-btn">Decline</button></div>
                    </div>`).join('');
                updateRequestsBadge(requests.length);
            };
            
            const renderFriends = (friendsList) => {
                conversationsList.innerHTML = friendsList
                    .sort((a, b) => Number(b.isOnline) - Number(a.isOnline))
                    .map(friend => `
                    <div class="conversation-item" data-user-id="${friend._id}" data-username="${friend.username}">
                        <div class="avatar"><img src="${friend.avatar || `https://i.pravatar.cc/150?u=${friend.username}` }" alt="Avatar"><div class="status-dot ${friend.isOnline ? 'online' : ''}"></div></div>
                        <div class="conversation-details"><div class="name">${friend.username}</div><div class="message-preview">Start a conversation...</div></div>
                        <div class="conversation-meta"><span class="conversation-time"></span><span class="badge hidden">0</span></div>
                    </div>`).join('');
            };
            
            const formatTime = (iso) => {
                try { const d = iso ? new Date(iso) : new Date(); return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); } catch { return ''; }
            };
            const formatDay = (iso) => {
                const d = iso ? new Date(iso) : new Date();
                return d.toLocaleDateString([], { year: 'numeric', month: 'short', day: 'numeric' });
            };
            const ensureDayDivider = (container, iso) => {
                const day = formatDay(iso);
                const lastDivider = container.querySelector('.day-divider:last-of-type');
                if (!lastDivider || lastDivider.dataset.day !== day) {
                    const div = document.createElement('div');
                    div.className = 'day-divider';
                    div.dataset.day = day;
                    div.textContent = day;
                    container.appendChild(div);
                }
            };
            const appendMessage = (message, type) => {
                const messageArea = document.getElementById('message-area'); if (!messageArea) return;
                ensureDayDivider(messageArea, message.createdAt);
                const row = document.createElement('div'); row.className = `message-row ${type}`;
                const bubble = document.createElement('div'); bubble.className = `message-bubble ${type}`; bubble.textContent = message.text;
                const time = document.createElement('div'); time.className = 'message-time'; time.textContent = formatTime(message.createdAt);
                bubble.appendChild(time);
                row.appendChild(bubble);
                messageArea.appendChild(row); messageArea.scrollTop = messageArea.scrollHeight;
            };

            const renderChatPanel = async (friendId, friendUsername, isOnline) => {
                activeChatFriendId = friendId;
                chatPanel.innerHTML = `<div class="chat-header"><div class="left"><div class="avatar"><img src="https://i.pravatar.cc/150?u=${friendUsername}" alt="Avatar"><div class="status-dot ${isOnline ? 'online' : ''}"></div></div><div class="user-info"><div class="name">${friendUsername}</div><div class="status-text ${isOnline ? 'online' : ''}">${isOnline ? 'Online' : 'Offline'}</div></div></div><div class="actions"><button class="icon-button" title="Search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></button><button class="icon-button" title="More"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button></div></div><div class="message-area" id="message-area"></div><div class="chat-input-area"><form class="chat-input-form" id="chat-input-form"><textarea id="chat-input" class="chat-input" placeholder="Type a message..." rows="1" required></textarea><button type="submit" class="send-button" title="Send"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></div>`;
                const messages = await apiRequest(`/api/conversations/${friendId}`, 'GET');
                messages.forEach(msg => appendMessage(msg, msg.sender._id === currentUserId ? 'sent' : 'received'));
                document.getElementById('message-area').scrollTop = document.getElementById('message-area').scrollHeight;
                const textarea = document.getElementById('chat-input');
                const autoResize = () => { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px'; };
                textarea.addEventListener('input', autoResize);
                autoResize();
                document.getElementById('chat-input-form').addEventListener('submit', (e) => { e.preventDefault(); const text = textarea.value.trim(); if (text && ws) { const messagePayload = { type: 'chat_message', recipientId: friendId, text: text }; ws.send(JSON.stringify(messagePayload)); appendMessage({ text: text, createdAt: new Date().toISOString() }, 'sent'); textarea.value = ''; autoResize(); } });
                textarea.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('chat-input-form').dispatchEvent(new Event('submit')); } });
            };
            
            const refreshDashboard = async () => { const requests = await apiRequest('/api/friend-requests', 'GET'); renderFriendRequests(requests); const friendsList = await apiRequest('/api/friends', 'GET'); renderFriends(friendsList); };
            const handleLoginSuccess = async (data, username) => { localStorage.setItem('token', data.token); localStorage.setItem('username', username); currentUserId = data.userId; currentUsernameEl.textContent = username; transitionToChat(); connectWebSocket(data.token); await refreshDashboard(); };

            // --- EVENT LISTENERS ---
            showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); loginError.style.opacity = 0; switchView(registerView, loginView); });
            showLoginLink.addEventListener('click', (e) => { e.preventDefault(); registerError.style.opacity = 0; switchView(loginView, registerView); });
            
            registerForm.addEventListener('submit', async (e) => { e.preventDefault(); const button = e.target.querySelector('button'); toggleLoading(button, true); registerError.style.opacity = 0; const username = document.getElementById('register-username').value.trim().toLowerCase(); const password = document.getElementById('register-password').value; try { await apiRequest('/register', 'POST', { username, password }); alert('Registration successful! Please log in.'); registerForm.reset(); switchView(loginView, registerView); } catch (error) { showError(registerError, error.message); } finally { toggleLoading(button, false); } });
            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); const button = e.target.querySelector('button'); toggleLoading(button, true); loginError.style.opacity = 0; const username = document.getElementById('login-username').value.trim().toLowerCase(); const password = document.getElementById('login-password').value; try { const data = await apiRequest('/login', 'POST', { username, password }); await handleLoginSuccess(data, username); } catch (error) { showError(loginError, error.message); } finally { toggleLoading(button, false); } });

            searchForm.addEventListener('submit', async (e) => { e.preventDefault(); const username = searchInput.value.trim().toLowerCase(); if (!username) return; try { const data = await apiRequest('/api/friend-requests/send', 'POST', { recipientUsername: username }); alert(data.message); searchInput.value = ''; } catch (error) { alert(`Error: ${error.message}`); } });
            
            friendRequestsList.addEventListener('click', async (e) => {
                const target = e.target; const requestItem = target.closest('.friend-request-item'); if (!requestItem) return;
                const requestId = requestItem.dataset.requestId; const response = target.classList.contains('accept-btn') ? 'accepted' : 'declined';
                if (target.classList.contains('accept-btn') || target.classList.contains('decline-btn')) {
                    try {
                        await apiRequest('/api/friend-requests/respond', 'POST', { requestId, response });
                        anime({ targets: requestItem, opacity: 0, height: 0, padding: '0px', margin: 0, duration: 300, easing: 'easeOutExpo', complete: () => requestItem.remove() });
                        if(response === 'accepted') await refreshDashboard();
                    } catch (error) { alert(`Error: ${error.message}`); }
                }
            });

            // Tabs switching
            const showFriends = () => { tabFriends.classList.add('active'); tabRequests.classList.remove('active'); friendsView.classList.remove('hidden'); requestsView.classList.add('hidden'); searchForm.classList.remove('hidden'); };
            const showRequests = () => { tabRequests.classList.add('active'); tabFriends.classList.remove('active'); requestsView.classList.remove('hidden'); friendsView.classList.add('hidden'); searchForm.classList.add('hidden'); };
            tabFriends.addEventListener('click', showFriends);
            tabRequests.addEventListener('click', showRequests);
            
            conversationsList.addEventListener('click', (e) => {
                const target = e.target.closest('.conversation-item');
                if (target) {
                    const friendId = target.dataset.userId; const friendUsername = target.dataset.username;
                    const isOnline = target.querySelector('.status-dot').classList.contains('online');
                    renderChatPanel(friendId, friendUsername, isOnline);
                    document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
                    target.classList.add('active');
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.clear();
                if (ws) ws.close();
                window.location.reload();
            });

            // --- INITIALIZATION ---
            registerView.classList.remove('visible'); animateEntrance(loginView);
            const token = localStorage.getItem('token');
            if (token) {
                authView.classList.remove('active'); chatAppView.classList.add('active');
                currentUsernameEl.textContent = localStorage.getItem('username');
                try {
                    currentUserId = JSON.parse(atob(token.split('.')[1])).userId;
                    connectWebSocket(token);
                    refreshDashboard();
                } catch(e) { console.error("Could not parse token on initial load, logging out."); localStorage.clear(); }
            }
        });
    </script>
</body>
</html>